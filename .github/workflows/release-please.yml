name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整 git 历史，Release Please 需要分析提交

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Automatic recovery: fix stuck release PRs
  fix-stuck-releases:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: release-please
    steps:
      - uses: actions/checkout@v4

      - name: Fix stuck release PR labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          get_changelog() {
            if [ -f "CHANGELOG.md" ]; then
              awk "/^## \[${VERSION}\]/,/^## \[/{if (!/^## \[${VERSION}\]/ && !/^## \[/) print}" CHANGELOG.md | sed '/^$/d' || true
            fi
          }

          # Ensure "autorelease: tagged" label exists once
          gh label create "autorelease: tagged" \
            --repo ${{ github.repository }} \
            --description "Release PR that has been tagged" \
            --color "0e8a16" 2>/dev/null || true

          # Find merged release PRs with "autorelease: pending" label
          STUCK_PRS=$(gh pr list \
            --repo ${{ github.repository }} \
            --state merged \
            --label "autorelease: pending" \
            --json number,title \
            --jq '.[].number')

          for PR_NUM in $STUCK_PRS; do
            echo "Checking PR #$PR_NUM..."

            # Get the version from PR title (format: "chore: release vX.Y.Z")
            PR_TITLE=$(gh pr view $PR_NUM --repo ${{ github.repository }} --json title --jq '.title')
            VERSION=$(echo "$PR_TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

            if [ -n "$VERSION" ]; then
              TAG="v$VERSION"

              # Check if tag exists
              if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
                echo "Tag $TAG exists, checking Release status..."

                # Check if Release exists
                if ! gh release view "$TAG" &>/dev/null; then
                  echo "Release $TAG not found, creating it..."

                  # Try to get changelog from CHANGELOG.md if it exists
                  CHANGELOG="$(get_changelog)"
                  if [ -n "$CHANGELOG" ]; then
                    gh release create "$TAG" \
                      --title "µTerm ${TAG}" \
                      --notes "$CHANGELOG"
                    echo "Created Release $TAG with changelog"
                  else
                    gh release create "$TAG" \
                      --title "µTerm ${TAG}" \
                      --generate-notes
                    echo "Created Release $TAG with auto-generated notes"
                  fi
                else
                  echo "Release $TAG already exists"
                fi

                # Update labels
                gh pr edit $PR_NUM \
                  --repo ${{ github.repository }} \
                  --remove-label "autorelease: pending" \
                  --add-label "autorelease: tagged"

                echo "Fixed PR #$PR_NUM (tag and release verified/created)"
              else
                echo "Tag $TAG does not exist yet for PR #$PR_NUM, skipping"
              fi
            else
              echo "Could not extract version from PR #$PR_NUM title: $PR_TITLE"
            fi
          done
