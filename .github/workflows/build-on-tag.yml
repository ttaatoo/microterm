name: Build on Tag

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build frontend
        run: bun run build

      - name: Build Tauri app
        run: bunx tauri build --bundles dmg

      - name: Upload assets to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"

          get_changelog() {
            if [ -f "CHANGELOG.md" ]; then
              awk "/^## \[${VERSION}\]/,/^## \[/{if (!/^## \[${VERSION}\]/ && !/^## \[/) print}" CHANGELOG.md | sed '/^$/d' || true
            fi
          }

          # If release doesn't exist, create it
          if gh release view "$TAG" &>/dev/null; then
            echo "Release $TAG found"
          else
            echo "Release $TAG not found, creating it..."

            # Try to get changelog from CHANGELOG.md if it exists
            CHANGELOG="$(get_changelog)"
            if [ -n "$CHANGELOG" ]; then
              gh release create "$TAG" \
                --title "µTerm ${TAG}" \
                --notes "$CHANGELOG"
            else
              gh release create "$TAG" \
                --title "µTerm ${TAG}" \
                --generate-notes
            fi
            echo "Created release $TAG"
          fi

          # Upload original DMG
          ORIGINAL_DMG="src-tauri/target/release/bundle/dmg/µTerm_${VERSION}_aarch64.dmg"
          if [ -f "$ORIGINAL_DMG" ]; then
            gh release upload "$TAG" "$ORIGINAL_DMG" --clobber
            echo "Uploaded: $ORIGINAL_DMG"
          else
            echo "Error: $ORIGINAL_DMG not found"
            exit 1
          fi

          # Create and upload renamed DMG for Homebrew
          RENAMED_DMG="src-tauri/target/release/bundle/dmg/microterm_${VERSION}_aarch64.dmg"
          cp "$ORIGINAL_DMG" "$RENAMED_DMG"
          gh release upload "$TAG" "$RENAMED_DMG" --clobber
          echo "Uploaded: $RENAMED_DMG"

      - name: Calculate SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RENAMED_DMG="src-tauri/target/release/bundle/dmg/microterm_${VERSION}_aarch64.dmg"
          SHA=$(shasum -a 256 "$RENAMED_DMG" | cut -d' ' -f1)
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA"

    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.sha.outputs.sha256 }}

  update-homebrew:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          SHA256="${{ needs.build.outputs.sha256 }}"

          if [ -z "$TAP_GITHUB_TOKEN" ]; then
            echo "TAP_GITHUB_TOKEN not set, skipping Homebrew update"
            echo "Manual update required:"
            echo "  version: $VERSION"
            echo "  sha256: $SHA256"
            exit 0
          fi

          # Clone tap repo
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/ttaatoo/homebrew-microterm.git"
          cd homebrew-microterm

          # Update version and sha256
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/microterm.rb
          sed -i "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/microterm.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/microterm.rb
          git commit -m "feat: bump to v${VERSION}"
          git push

          echo "Homebrew tap updated to v${VERSION}"
